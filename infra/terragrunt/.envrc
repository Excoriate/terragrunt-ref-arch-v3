#!/usr/bin/env bash
# Terragrunt Layer Environment Configuration
# shellcheck shell=bash
# shellcheck disable=SC2155
# shellcheck source=/dev/null

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/.."

# Robust utility script sourcing with explicit path resolution
# Ensure absolute path and quote the source
source "${PROJECT_ROOT}/scripts/envrc-utils.sh"

# Layer name with defensive default and explicit variable handling
# Quote variable to prevent word splitting
LAYER_NAME="${LAYER_NAME:-TERRAGRUNT}"
_log "INFO" "Initializing Terragrunt Layer: ${LAYER_NAME}"

# Terragrunt Cache and Performance Settings
# Quote variables in function calls
_layer_export TERRAGRUNT_DOWNLOAD_DIR \
  "${HOME}/.terragrunt-cache/$(basename "${PROJECT_ROOT}")" \
  "${LAYER_NAME}"

_layer_export TERRAGRUNT_CACHE_MAX_AGE "168h" "${LAYER_NAME}"

# Terragrunt Logging and Output Control
_layer_export TERRAGRUNT_LOG_LEVEL "${TERRAGRUNT_LOG_LEVEL:-info}" "${LAYER_NAME}"
_layer_export TERRAGRUNT_DISABLE_CONSOLE_OUTPUT \
  "${TERRAGRUNT_DISABLE_CONSOLE_OUTPUT:-false}" \
  "${LAYER_NAME}"

# Terraform and Terragrunt Version Management
_layer_export TF_INPUT "${TF_INPUT:-0}" "${LAYER_NAME}"
_layer_export TERRAGRUNT_AUTO_INIT "${TERRAGRUNT_AUTO_INIT:-true}" "${LAYER_NAME}"
_layer_export TERRAGRUNT_AUTO_RETRY "${TERRAGRUNT_AUTO_RETRY:-true}" "${LAYER_NAME}"

# Display Terragrunt layer information
# Ensure proper quoting of arguments
_layer_env_info "${LAYER_NAME}" \
  "TERRAGRUNT_DOWNLOAD_DIR:Terragrunt Download Directory" \
  "TERRAGRUNT_LOG_LEVEL:Terragrunt Log Level" \
  "TERRAGRUNT_AUTO_INIT:Auto Initialize" \
  "TERRAGRUNT_AUTO_RETRY:Auto Retry"

# Display exported variables for this layer
_display_exported_vars "TERRAGRUNT_"
